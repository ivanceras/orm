package com.ivanceras.db.server.util.generators;

import com.ivanceras.commons.conf.Configuration;
import static com.ivanceras.db.server.util.DAOGenerator.Array;
import com.ivanceras.commons.strings.CStringUtils;
import com.ivanceras.commons.writer.FileUtil;
import com.ivanceras.commons.writer.SourceWriter;
import com.ivanceras.commons.writer.StringSourceWriter;
import com.ivanceras.db.api.DAO_Operator;
import com.ivanceras.db.api.EntityManager;
import com.ivanceras.db.api.IDatabase;
import com.ivanceras.db.api.ModelDef;
import com.ivanceras.db.shared.DAO;
import com.ivanceras.db.shared.datatype.DataTypeGeneric;
import com.ivanceras.db.shared.datatype.DataTypeJava;
import com.ivanceras.db.shared.util.SpecialCase;

public class DAOClassGenerator {
	
	
	private boolean generateDAOClass(ModelDef modeldef, Configuration conf, boolean useCentralizeString, boolean includeDepracated){
		SourceWriter sw = new StringSourceWriter();
		String directory = conf.daodirectory;
		String packageName = conf.daopackageName;
		String modelName = modeldef.getModelName();
		boolean useCamelCase = conf.useCamelCase;
		if(useCamelCase){
			modelName = CStringUtils.camelCaseUnderscores(modelName);
		}
		String className = CStringUtils.capitalize(modelName, useCamelCase);
		String varClassName = CStringUtils.toVariableName(className, useCamelCase);
		sw.print("package "+packageName+";");
		sw.lnprint("");
		sw.lnprint("/***");
		sw.lnprint("* This is automatically generated by "+DAOClassGenerator.class.getCanonicalName()+", based on the database table schema");
		sw.lnprint("* ");
		sw.lnprint("* ");
		sw.lnprint("*/");
		sw.lnprint("");
		sw.lnprint("import "+DAO.class.getCanonicalName()+";");
		sw.lnprint("import "+conf.metaDataPackageName+".Column;");
		sw.lnprint("public class DAO_"+className+" extends DAO{");
		sw.lnprint("/**");
		sw.lnprint(" *"); 
		sw.lnprint(" */");

		String[] attributes = modeldef.getAttributes();
		String[] dataTypes = DataTypeJava.fromGenericDataType(modeldef.getDataTypes());
		if(modeldef.getSubClass() != null && modeldef.getSubClass().length > 0){
			String[] subclassAttributes = {IDatabase.SUBCLASSTABLE};
			attributes = CStringUtils.mergeString(attributes, subclassAttributes);
			String[] subclassDatatypes = {DataTypeGeneric.STRING};
			dataTypes = CStringUtils.mergeString(dataTypes, subclassDatatypes);
		}
		String[] hasOne = modeldef.getHasOne();
		String[] distinctHasOne = BeanGenerator.getDistinctString(hasOne);
		String[] hasMany = modeldef.getHasMany();


		sw.lnprint("");
		sw.lnprint("");
		sw.lnTabPrint("public DAO_"+className+"(){");
		sw.lnTabPrint("    super(\""+className+"\");");
		sw.lnTabPrint("}");
		sw.lnprint("");
		for(int i = 0; i < attributes.length; i++){
			//			System.out.lnprint("attribute["+i+"]: "+attributes[i]);
			String att = SpecialCase.getEquiv(attributes[i]);
			String columnName = CStringUtils.toVariableName(att);
			att = CStringUtils.capitalize(att.toLowerCase(),useCamelCase);
			String attVar = CStringUtils.toVariableName(att,useCamelCase);
			String datatype = dataTypes[i];
			sw.lnTabPrint("public "+datatype+" get"+att+"(){");
			sw.lnTabPrint("    return ("+datatype+")get_Value(Column."+columnName+");");
			sw.lnTabPrint("}");
			sw.lnprint("");
			sw.lnTabPrint("public void set"+att+"("+datatype+" "+attVar+"){");
			sw.lnTabPrint("    set_Value(Column."+columnName+", "+attVar+");");
			sw.lnTabPrint("}");
			sw.lnprint("");
		}

		for(int i = 0; i < distinctHasOne.length; i++){
			String distinctHasOneStr = CStringUtils.capitalize(distinctHasOne[i].toLowerCase(),useCamelCase);
			String distinctHasOneVar = CStringUtils.toVariableName(distinctHasOneStr,useCamelCase);
			sw.lnprint("");
			sw.lnTabPrint("public void set"+distinctHasOneStr+"(DAO_"+distinctHasOneStr+" "+distinctHasOneVar+"){");
			sw.lnTabPrint("    set_Value(\""+distinctHasOne[i]+"\", "+distinctHasOneVar+");");
			sw.lnTabPrint("}");
			sw.lnprint("");
			sw.lnTabPrint("public DAO_"+distinctHasOneStr+" get"+distinctHasOneStr+"(){");
			sw.lnTabPrint("    return (DAO_"+distinctHasOneStr+")get_Value(\""+distinctHasOne[i]+"\");");
			sw.lnTabPrint("}");
		}


		for(int i = 0; i < hasMany.length; i++){
			String hasManyStr = CStringUtils.capitalize(hasMany[i].toLowerCase(),useCamelCase);
			String hasManyVar = CStringUtils.toVariableName(hasManyStr,useCamelCase);
			sw.lnprint("");
			sw.lnTabPrint("public void set"+hasManyStr+Array+"(DAO_"+hasManyStr+"[] "+hasManyVar+Array+"){");
			sw.lnTabPrint("    set_Value(\""+hasMany[i]+Array+"\", "+hasManyVar+Array+");");
			sw.lnTabPrint("}");
			sw.lnprint("");
			sw.lnTabPrint("public DAO_"+hasManyStr+"[] get"+hasManyStr+Array+"(){");
			sw.lnTabPrint("    return (DAO_"+hasManyStr+"[])get_Value(\""+hasMany[i]+Array+"\");");
			sw.lnTabPrint("}");
		}
		if(includeDepracated){
			sw.lnprint("");
			sw.lnTabPrint("/**");
			sw.lnTabPrint(" * @deprecated user{@link "+EntityManager.class.getSimpleName()+".cast(DAO_"+className+".class, dao); instead))}");
			sw.lnTabPrint(" * @param dao");
			sw.lnTabPrint(" * @return DAO_"+className+"");
			sw.lnTabPrint(" */");
			sw.lnTabPrint("@Deprecated");
			sw.lnTabPrint("public static DAO_"+className+" cast(DAO dao){");
			sw.lnTabPrint("    if(dao == null){");
			sw.lnTabPrint("        return null;");
			sw.lnTabPrint("    }");
			sw.lnTabPrint("    else if(DAO_"+className+".class.equals(dao.getClass())){");
			sw.lnTabPrint("        return (DAO_"+className+") dao;");
			sw.lnTabPrint("    }");
			sw.lnTabPrint("    else{");
			sw.lnTabPrint("        DAO_"+className+" "+varClassName+" = "+DAO_Operator.class.getSimpleName()+".cast(new DAO_"+className+"(), \""+className+"\", dao);");
			sw.lnTabPrint("        return "+varClassName+";");
			sw.lnTabPrint("    }");
			sw.lnTabPrint("}");
			sw.lnTabPrint("");
			sw.lnTabPrint("/**");
			sw.lnTabPrint(" * @deprecated user{@link "+EntityManager.class.getSimpleName()+".cast(DAO_"+className+".class, daoArray); instead))}");
			sw.lnTabPrint(" * @param daoArray");
			sw.lnTabPrint(" * @return DAO_"+className+"[]");
			sw.lnTabPrint(" */");
			sw.lnTabPrint("@Deprecated");
			sw.lnTabPrint("public static DAO_"+className+"[] cast(DAO[] daoArray){");
			sw.lnTabPrint("    if(daoArray == null){");
			sw.lnTabPrint("        return null;");
			sw.lnTabPrint("    }");
			sw.lnTabPrint("    else if(DAO_"+className+"[].class.equals(daoArray.getClass())){");
			sw.lnTabPrint("        return (DAO_"+className+"[]) daoArray;");
			sw.lnTabPrint("    }");
			sw.lnTabPrint("    else{");
			sw.lnTabPrint("        DAO_"+className+"[] "+varClassName+Array+" = "+DAO_Operator.class.getSimpleName()+".cast(new DAO_"+className+"[daoArray.length],\""+className+"\", daoArray);");
			sw.lnTabPrint("        return "+varClassName+Array+";");
			sw.lnTabPrint("    }");
			sw.lnTabPrint("}");
		}

		sw.lnTabPrint("");

		sw.lnprint("}");
		FileUtil.writeToFile(sw.toString(), directory, "DAO_"+className+".java");
		return true;
	}

	public void start(ModelDef[] modelList, Configuration conf, boolean useCentralizeString,
			boolean includeDepracated) {
		for(ModelDef model : modelList){
			generateDAOClass(model, conf, useCentralizeString, includeDepracated);
		}
		
	}
}
